name: build-and-release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-and-release
  cancel-in-progress: true

jobs:
  tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: tauri-linux
          - os: macos-latest
            artifact_name: tauri-macos
          - os: windows-latest
            artifact_name: tauri-windows

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Cargo Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock', 'src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Tauri CLI
        shell: bash
        run: |
          if ! command -v cargo-tauri >/dev/null 2>&1; then
            cargo install tauri-cli --version "^1.5"
          else
            echo "tauri-cli already installed"
          fi

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            libsoup2.4-dev \
            libjavascriptcoregtk-4.1-dev \
            patchelf \
            libssl-dev \
            pkg-config

      - name: Build Tauri App
        working-directory: src-tauri
        run: cargo tauri build

      - name: Debug Bundle Paths
        shell: bash
        run: |
          echo "Listing src-tauri/target/release:"
          ls -la src-tauri/target/release || true
          echo "Listing src-tauri/target/release/bundle:"
          ls -la src-tauri/target/release/bundle || true

      - name: Collect Bundles (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p dist
          cp -R src-tauri/target/release/bundle/* dist/ || true
          if [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "No bundle artifacts found."
            exit 1
          fi

      - name: Collect Bundles (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p dist
          cp -R src-tauri/target/release/bundle/* dist/ || true
          if [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "No bundle artifacts found."
            exit 1
          fi

      - name: Collect Bundles (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $dir = "src-tauri/target/release/bundle"
          if (Test-Path $dir) {
            Copy-Item -Recurse -Force "$dir/*" dist/ -ErrorAction SilentlyContinue
          }
          if (-not (Get-ChildItem -Path dist -Recurse -ErrorAction SilentlyContinue | Where-Object { -not $_.PSIsContainer })) {
            Write-Error "No bundle artifacts found."
          }

      - name: Upload Tauri Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist

      - name: Save Cargo Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock', 'src-tauri/Cargo.lock') }}

  release:
    needs: [tauri]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Compute Version
        id: version
        shell: bash
        run: |
          version=$(sed -n 's/^version = \"\\([0-9.]*\\)\"/\\1/p' Cargo.toml | head -n1)
          if [ -z "$version" ]; then
            echo "Unable to read version from Cargo.toml"
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Publish Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          files: dist/**/*
